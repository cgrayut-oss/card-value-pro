<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Card Value Pro - AI Card Recognition</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            min-height: 100vh;
            background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 50%, #2a1f3a 100%);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            color: #ffffff;
            padding: 1rem;
            overflow-x: hidden;
        }

        .hero-section {
            text-align: center;
            padding: 2rem 0;
            position: relative;
        }

        .settings-button {
            position: absolute;
            top: 0;
            right: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            background: rgba(96, 239, 255, 0.1);
            border: 1px solid rgba(96, 239, 255, 0.3);
            border-radius: 8px;
            color: #60efff;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .settings-button:hover {
            background: rgba(96, 239, 255, 0.2);
            border-color: #60efff;
        }

        .title {
            font-size: 2.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, #60efff 0%, #0061ff 50%, #ff00e5 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
            letter-spacing: -0.03em;
        }

        .subtitle {
            font-size: 1rem;
            color: #a0aec0;
            margin-bottom: 0.5rem;
        }

        .demo-badge {
            display: inline-block;
            padding: 0.5rem 1rem;
            background: rgba(251, 191, 36, 0.2);
            border: 1px solid #fbbf24;
            border-radius: 20px;
            color: #fcd34d;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .container.batch-active {
            padding-bottom: 70px;
        }

        .photo-section {
            margin-bottom: 1.5rem;
        }

        .photo-section h3 {
            color: #60efff;
            margin-bottom: 1rem;
            font-size: 1.25rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .photo-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-bottom: 2rem;
            min-height: 250px;
        }

        .photo-wrapper {
            aspect-ratio: 3/4;
            position: relative;
            min-height: 250px;
            display: flex;
            align-items: stretch;
        }

        .camera-button {
            width: 100%;
            height: 100%;
            min-height: 250px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            background: rgba(255, 255, 255, 0.05);
            border: 2px dashed rgba(96, 239, 255, 0.3);
            border-radius: 12px;
            color: #60efff;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .camera-button:active {
            background: rgba(96, 239, 255, 0.1);
            border-color: #60efff;
        }

        .photo-preview {
            position: relative;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            overflow: hidden;
        }

        .photo-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .remove-photo {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: rgba(239, 68, 68, 0.9);
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            cursor: pointer;
            font-size: 1.2rem;
        }

        .photo-label {
            position: absolute;
            bottom: 0.5rem;
            left: 0.5rem;
            background: rgba(0, 0, 0, 0.8);
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .ai-analyze-button {
            width: 100% !important;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            color: white !important;
            border: none !important;
            padding: 1.5rem !important;
            border-radius: 12px !important;
            font-size: 1.2rem !important;
            font-weight: 800 !important;
            cursor: pointer !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            gap: 0.5rem !important;
            transition: all 0.3s !important;
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.5) !important;
            margin-top: 2rem !important;
            margin-bottom: 2rem !important;
            position: relative !important;
            z-index: 1000 !important;
            clear: both !important;
        }

        @keyframes glow {
            0%, 100% { box-shadow: 0 10px 30px rgba(96, 239, 255, 0.4); }
            50% { box-shadow: 0 10px 40px rgba(96, 239, 255, 0.6); }
        }

        .ai-analyze-button:active {
            transform: scale(0.98);
        }

        .ai-analyze-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            animation: none;
        }

        .card-identification {
            margin-top: 1.5rem;
            padding: 1.5rem;
            background: rgba(16, 185, 129, 0.1);
            border: 2px solid rgba(16, 185, 129, 0.3);
            border-radius: 12px;
        }

        .card-identification h4 {
            color: #10b981;
            margin-bottom: 1rem;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .identification-details {
            display: grid;
            gap: 0.75rem;
        }

        .id-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 6px;
        }

        .id-label {
            color: #a0aec0;
            font-size: 0.875rem;
        }

        .id-value {
            color: #ffffff;
            font-weight: 600;
            font-size: 0.875rem;
        }

        .divider {
            display: flex;
            align-items: center;
            text-align: center;
            margin: 2rem 0;
            color: #718096;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .divider::before,
        .divider::after {
            content: '';
            flex: 1;
            border-bottom: 1px solid rgba(96, 239, 255, 0.2);
        }

        .divider span {
            padding: 0 1rem;
        }

        .input-group {
            display: grid;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .input-wrapper {
            position: relative;
        }

        .input-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: #60efff;
        }

        input {
            width: 100%;
            padding: 1rem 1rem 1rem 3rem;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(96, 239, 255, 0.2);
            border-radius: 12px;
            color: #ffffff;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        input:focus {
            outline: none;
            border-color: #60efff;
            background: rgba(255, 255, 255, 0.08);
        }

        input::placeholder {
            color: #718096;
        }

        .search-button {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg, #60efff 0%, #0061ff 100%);
            border: none;
            border-radius: 12px;
            color: #ffffff;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 10px 30px rgba(96, 239, 255, 0.3);
        }

        .search-button:active {
            transform: scale(0.98);
        }

        .search-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .error-message,
        .info-message {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            font-size: 0.9rem;
        }

        .error-message {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #fca5a5;
        }

        .info-message {
            background: rgba(96, 239, 255, 0.1);
            border: 1px solid rgba(96, 239, 255, 0.3);
            color: #60efff;
        }

        /* Sold Listings Section */
        .listings-section {
            margin-top: 1.5rem;
        }

        .listings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
            flex-wrap: wrap;
            gap: 0.75rem;
        }

        .listings-title-group {
            display: flex;
            align-items: baseline;
            gap: 0.75rem;
        }

        .listings-header h3 {
            color: #60efff;
            font-size: 1.1rem;
            margin: 0;
        }

        .listings-count {
            color: #718096;
            font-size: 0.85rem;
        }

        .listings-controls {
            display: flex;
            gap: 0.5rem;
        }

        .selection-btn {
            padding: 0.4rem 0.8rem;
            background: rgba(96, 239, 255, 0.1);
            border: 1px solid rgba(96, 239, 255, 0.3);
            border-radius: 6px;
            color: #60efff;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .selection-btn:hover {
            background: rgba(96, 239, 255, 0.2);
            border-color: #60efff;
        }

        .selection-btn:active {
            transform: scale(0.95);
        }

        .listings-container {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .listing-item {
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(96, 239, 255, 0.15);
            border-radius: 10px;
            padding: 0.75rem;
            transition: background 0.2s ease;
            display: flex;
            gap: 0.85rem;
            align-items: center;
        }

        .listing-item:hover {
            background: rgba(96, 239, 255, 0.08);
            border-color: rgba(96, 239, 255, 0.35);
        }

        .listing-item.listing-deselected {
            opacity: 0.4;
            background: rgba(255, 255, 255, 0.01);
            border-color: rgba(96, 239, 255, 0.1);
        }

        .listing-checkbox-wrap {
            flex-shrink: 0;
            display: flex;
            align-items: center;
        }

        .listing-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: #60efff;
        }

        .listing-image-wrap {
            flex-shrink: 0;
            width: 80px;
            height: 80px;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid rgba(96, 239, 255, 0.2);
            background: rgba(255, 255, 255, 0.05);
        }

        .listing-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .listing-image-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            color: #4a5568;
        }

        .listing-info {
            flex: 1;
            min-width: 0;
        }

        .listing-title {
            color: #e2e8f0;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            line-height: 1.3;
        }

        .listing-title-link {
            color: #60efff;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            line-height: 1.3;
            text-decoration: none;
            display: block;
            transition: color 0.2s ease;
        }

        .listing-title-link:hover {
            color: #a0f0ff;
            text-decoration: underline;
        }

        .listing-title-link:visited {
            color: #a78bfa;
        }

        .listing-details {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .listing-price {
            color: #60efff;
            font-weight: 700;
            font-size: 1rem;
        }

        .listing-condition {
            color: #a0aec0;
            font-size: 0.82rem;
            background: rgba(255, 255, 255, 0.06);
            padding: 0.2rem 0.6rem;
            border-radius: 12px;
        }

        .listing-date {
            color: #718096;
            font-size: 0.82rem;
        }

        /* Batch Mode */
        .batch-toggle-button {
            position: absolute;
            top: 0;
            left: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            background: rgba(167, 139, 250, 0.1);
            border: 1px solid rgba(167, 139, 250, 0.3);
            border-radius: 8px;
            color: #a78bfa;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .batch-toggle-button:hover {
            background: rgba(167, 139, 250, 0.2);
            border-color: #a78bfa;
        }

        .batch-toggle-button.active {
            background: rgba(167, 139, 250, 0.25);
            border-color: #a78bfa;
            box-shadow: 0 0 12px rgba(167, 139, 250, 0.3);
        }

        .add-to-batch-btn {
            width: 100%;
            margin-top: 1rem;
            padding: 0.85rem;
            background: linear-gradient(135deg, rgba(167, 139, 250, 0.2), rgba(167, 139, 250, 0.1));
            border: 1px solid rgba(167, 139, 250, 0.5);
            border-radius: 12px;
            color: #a78bfa;
            font-size: 1.05rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
            letter-spacing: 0.02em;
        }

        .add-to-batch-btn:hover {
            background: linear-gradient(135deg, rgba(167, 139, 250, 0.35), rgba(167, 139, 250, 0.2));
            border-color: #a78bfa;
            box-shadow: 0 0 16px rgba(167, 139, 250, 0.3);
        }

        /* Batch Tray - fixed bottom panel */
        .batch-tray {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(15, 18, 40, 0.95);
            border-top: 1px solid rgba(167, 139, 250, 0.4);
            backdrop-filter: blur(12px);
            z-index: 100;
            transition: transform 0.3s ease;
        }

        .batch-tray-header {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            cursor: pointer;
            gap: 0.6rem;
        }

        .batch-tray-title {
            font-weight: 700;
            color: #a78bfa;
            font-size: 1rem;
        }

        .batch-tray-count {
            color: #718096;
            font-size: 0.82rem;
            flex: 1;
        }

        .batch-tray-expand {
            background: none;
            border: none;
            color: #a78bfa;
            font-size: 0.9rem;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .batch-tray-expand.expanded {
            transform: rotate(180deg);
        }

        /* Expanded batch panel */
        .batch-expanded {
            padding: 0 1rem 1rem;
            max-height: 50vh;
            overflow-y: auto;
        }

        .batch-items-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .batch-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(167, 139, 250, 0.15);
            border-radius: 10px;
            padding: 0.7rem 0.85rem;
        }

        .batch-item-number {
            background: rgba(167, 139, 250, 0.2);
            color: #a78bfa;
            font-weight: 700;
            font-size: 0.82rem;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .batch-item-info {
            flex: 1;
            min-width: 0;
        }

        .batch-item-name {
            color: #e2e8f0;
            font-size: 0.88rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .batch-item-prices {
            display: flex;
            gap: 1rem;
            margin-top: 0.2rem;
        }

        .batch-item-avg {
            color: #60efff;
            font-size: 0.82rem;
        }

        .batch-item-suggested {
            color: #a78bfa;
            font-size: 0.82rem;
        }

        .batch-item-remove {
            background: none;
            border: none;
            color: #718096;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            transition: color 0.2s;
            flex-shrink: 0;
        }

        .batch-item-remove:hover {
            color: #fc8181;
        }

        /* Batch Summary */
        .batch-summary {
            background: rgba(167, 139, 250, 0.08);
            border: 1px solid rgba(167, 139, 250, 0.2);
            border-radius: 10px;
            padding: 0.85rem 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.55rem;
        }

        .batch-summary-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #a0aec0;
            font-size: 0.88rem;
        }

        .batch-summary-row span:last-child {
            font-weight: 600;
            color: #e2e8f0;
        }

        .batch-summary-row.highlight {
            margin-top: 0.3rem;
            padding-top: 0.55rem;
            border-top: 1px solid rgba(167, 139, 250, 0.25);
            color: #a78bfa;
            font-size: 1rem;
            font-weight: 700;
        }

        .batch-summary-row.highlight span:last-child {
            color: #a78bfa;
            font-size: 1.2rem;
        }

        .batch-clear-btn {
            width: 100%;
            margin-top: 0.85rem;
            padding: 0.6rem;
            background: rgba(252, 129, 129, 0.1);
            border: 1px solid rgba(252, 129, 129, 0.3);
            border-radius: 8px;
            color: #fc8181;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .batch-clear-btn:hover {
            background: rgba(252, 129, 129, 0.2);
        }

        .loading-state {
            text-align: center;
            padding: 3rem 1rem;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid rgba(96, 239, 255, 0.2);
            border-top-color: #60efff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .results-section {
            animation: fadeIn 0.6s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .recommendation-badge {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            padding: 1.5rem;
            border-radius: 16px;
            margin-bottom: 2rem;
            font-size: 1.25rem;
            font-weight: 700;
        }

        .recommendation-badge.buy {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.2) 0%, rgba(5, 150, 105, 0.2) 100%);
            border: 2px solid #10b981;
            color: #6ee7b7;
        }

        .recommendation-badge.consider {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.2) 0%, rgba(245, 158, 11, 0.2) 100%);
            border: 2px solid #fbbf24;
            color: #fcd34d;
        }

        .recommendation-badge.pass {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.2) 0%, rgba(220, 38, 38, 0.2) 100%);
            border: 2px solid #ef4444;
            color: #fca5a5;
        }

        .metrics-grid {
            display: grid;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .metric-card {
            padding: 1.5rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(96, 239, 255, 0.2);
            border-radius: 16px;
        }

        .metric-card.primary {
            background: linear-gradient(135deg, rgba(96, 239, 255, 0.1) 0%, rgba(0, 97, 255, 0.1) 100%);
            border: 2px solid #60efff;
        }

        .metric-label {
            font-size: 0.75rem;
            color: #a0aec0;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .metric-value {
            font-size: 2rem;
            font-weight: 800;
            color: #ffffff;
            margin: 0.5rem 0;
        }

        .metric-value.positive {
            color: #6ee7b7;
        }

        .metric-value.negative {
            color: #fca5a5;
        }

        .metric-detail {
            font-size: 0.875rem;
            color: #718096;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 1rem;
        }

        .modal-overlay.active {
            display: flex;
        }

        .settings-modal-content {
            background: linear-gradient(135deg, #1a1f3a 0%, #2a1f3a 100%);
            border: 2px solid rgba(96, 239, 255, 0.3);
            border-radius: 16px;
            padding: 2rem;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .modal-header h2 {
            color: #60efff;
            font-size: 1.75rem;
        }

        .settings-body {
            display: grid;
            gap: 2rem;
        }

        .settings-section h3 {
            color: #60efff;
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .setting-item label {
            color: #cbd5e0;
            font-size: 0.95rem;
        }

        .setting-item input {
            width: 120px;
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(96, 239, 255, 0.3);
            border-radius: 8px;
            color: white;
            font-size: 1rem;
        }

        .setting-item input:focus {
            outline: none;
            border-color: #60efff;
            background: rgba(255, 255, 255, 0.08);
        }

        .modal-footer {
            display: flex;
            justify-content: space-between;
            gap: 1rem;
            margin-top: 2rem;
        }

        .reset-button,
        .save-button {
            padding: 1rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.95rem;
        }

        .reset-button {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #fca5a5;
        }

        .reset-button:active {
            background: rgba(239, 68, 68, 0.3);
        }

        .save-button {
            background: linear-gradient(135deg, #60efff 0%, #0061ff 100%);
            color: white;
            box-shadow: 0 5px 20px rgba(96, 239, 255, 0.3);
            flex: 1;
        }

        .save-button:active {
            transform: scale(0.98);
        }

        .camera-content {
            background: #000;
            border-radius: 16px;
            overflow: hidden;
            max-width: 600px;
            width: 100%;
        }

        .camera-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: linear-gradient(135deg, #1a1f3a 0%, #2a1f3a 100%);
            border-bottom: 2px solid #60efff;
        }

        .camera-header h3 {
            color: #60efff;
            font-size: 1rem;
        }

        .close-button {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: white;
            cursor: pointer;
            padding: 0.5rem;
            font-size: 1.2rem;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .camera-video {
            width: 100%;
            display: block;
        }

        .camera-controls {
            padding: 1.5rem;
            background: linear-gradient(135deg, #1a1f3a 0%, #2a1f3a 100%);
            display: flex;
            justify-content: center;
        }

        .capture-button {
            position: fixed !important;
            bottom: 120px !important;
            left: 50% !important;
            transform: translateX(-50%) !important;
            background: #60efff !important;
            color: #0a0e27 !important;
            border: 4px solid #0a0e27 !important;
            padding: 1.8rem 4rem !important;
            border-radius: 50px !important;
            font-size: 1.4rem !important;
            font-weight: 900 !important;
            cursor: pointer !important;
            box-shadow: 0 10px 40px rgba(96, 239, 255, 0.9) !important;
            z-index: 99999 !important;
            min-width: 280px !important;
            text-transform: uppercase !important;
        }

        .hidden {
            display: none;
        }

        @media (min-width: 768px) {
            .title {
                font-size: 4rem;
            }
            
            .metrics-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Help Icon & Tooltip Styles */
        .field-with-help {
            position: relative;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .help-icon {
            background: rgba(167, 139, 250, 0.2);
            color: #a78bfa;
            border: 1px solid rgba(167, 139, 250, 0.3);
            border-radius: 50%;
            width: 22px;
            height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 700;
            cursor: help;
            flex-shrink: 0;
            transition: all 0.2s;
        }
        
        .help-icon:hover {
            background: rgba(167, 139, 250, 0.4);
            transform: scale(1.1);
        }
        
        .help-tooltip {
            position: fixed !important;
            top: 50% !important;
            left: 50% !important;
            transform: translate(-50%, -50%) !important;
            background: rgba(20, 20, 40, 0.98) !important;
            border: 3px solid rgba(167, 139, 250, 0.8) !important;
            border-radius: 12px !important;
            padding: 1rem 1.5rem !important;
            max-width: 90% !important;
            width: auto !important;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.8) !important;
            z-index: 999999 !important;
            pointer-events: none !important;
            opacity: 0 !important;
            transition: opacity 0.2s !important;
        }
        
        .help-icon:hover .help-tooltip {
            position: fixed !important;
            top: 50% !important;
            left: 50% !important;
            transform: translate(-50%, -50%) !important;
            background: rgba(20, 20, 40, 0.98) !important;
            border: 3px solid rgba(167, 139, 250, 0.8) !important;
            border-radius: 12px !important;
            padding: 1rem 1.5rem !important;
            max-width: 90% !important;
            width: auto !important;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.8) !important;
            z-index: 999999 !important;
            pointer-events: none !important;
            opacity: 0 !important;
            transition: opacity 0.2s !important;
        }
        
        .help-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: rgba(167, 139, 250, 0.4);
        }
        
        .help-tooltip-title {
            color: #a78bfa;
            font-weight: 700;
            font-size: 0.85rem;
            margin-bottom: 0.3rem;
        }
        
        .help-tooltip-text {
            color: #cbd5e0;
            font-size: 0.8rem;
            line-height: 1.4;
        }

        /* Microphone Button */
        .mic-button {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(167, 139, 250, 0.2);
            border: 1px solid rgba(167, 139, 250, 0.4);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1.2rem;
        }
        
        .mic-button:hover {
            background: rgba(167, 139, 250, 0.3);
            border-color: rgba(167, 139, 250, 0.6);
        }
        
        .mic-button.listening {
            background: rgba(239, 68, 68, 0.3);
            border-color: rgba(239, 68, 68, 0.6);
            animation: pulse-red 1.5s infinite;
        }
        
        @keyframes pulse-red {
            0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            50% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
        }
    </style>
</head>
<body>
    <div class="hero-section">
        <button class="settings-button" onclick="openSettings()">
            ‚öôÔ∏è Cost Settings
        </button>
        <button class="batch-toggle-button" id="batchToggleBtn" onclick="toggleBatchMode()" style="display: flex; align-items: center; gap: 0.5rem; justify-content: center;">
            <span>üì¶ Batch Mode</span>
            <div class="help-icon" onclick="event.stopPropagation();">
                ?
                <div class="help-tooltip" style="left: auto; right: 0; transform: none;">
                    <div class="help-tooltip-title">Batch Mode</div>
                    <div class="help-tooltip-text">Analyze multiple cards at once! Add cards one by one, then see total investment, total value, and overall ROI. Perfect for evaluating bulk purchases or show inventory.</div>
                </div>
            </div>
        </button>
        <h1 class="title">Card Value Pro</h1>
        <p class="subtitle">AI-powered card identification & market analysis</p>
        <div class="demo-badge" id="apiBadge">eBay Production Mode - Real Market Data Active! üöÄ</div>
    </div>

    <div class="container">
        <!-- Asking Price Field - Optional, User Can Enter First -->
        <div class="input-group" style="margin-bottom: 1.5rem;">
            <div class="input-wrapper field-with-help">
                <span class="input-icon">üí≤</span>
                <input type="number" id="sellerPrice" placeholder="Asking price (optional)">
                <div class="help-icon">
                    ?
                    <div class="help-tooltip">
                        <div class="help-tooltip-title">Asking Price</div>
                        <div class="help-tooltip-text">Enter the seller's asking price if known. This helps calculate potential profit margins and ROI. Leave blank if unknown.</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="photo-section">
            <h3>
                <span>‚ú®</span> AI Card Recognition
            </h3>
            <div class="photo-buttons">
                <div class="photo-wrapper">
                    <div id="frontPhotoPreview" class="hidden">
                        <div class="photo-preview">
                            <img id="frontPhotoImg" src="" alt="Card Front">
                            <button class="remove-photo" onclick="removePhoto('front')">√ó</button>
                            <span class="photo-label">Front</span>
                        </div>
                    </div>
                    <button id="frontCameraButton" class="camera-button" onclick="selectPhotoFile('front')">
                        <span style="font-size: 2rem;">üìÅ</span>
                        <span>Select Front Photo</span>
                    </button>
                </div>
                
                <div class="photo-wrapper">
                    <div id="backPhotoPreview" class="hidden">
                        <div class="photo-preview">
                            <img id="backPhotoImg" src="" alt="Card Back">
                            <button class="remove-photo" onclick="removePhoto('back')">√ó</button>
                            <span class="photo-label">Back</span>
                        </div>
                    </div>
                    <button id="backCameraButton" class="camera-button" onclick="selectPhotoFile('back')">
                        <span style="font-size: 2rem;">üìÅ</span>
                        <span>Select Back Photo</span>
                    </button>
                </div>
            </div>

            <!-- Hidden file inputs for photo upload -->
            <input type="file" id="frontFileInput" accept="image/*" style="display: none;">
            <input type="file" id="backFileInput" accept="image/*" style="display: none;">

            <button id="aiAnalyzeButton" class="ai-analyze-button hidden" onclick="analyzeCard()">
                <span>üëÅ</span>
                <span>AI Identify Card</span>
            </button>

            <div id="cardIdentification" class="card-identification hidden">
                <h4>
                    <span>‚úì</span> Card Identified
                </h4>
                <div id="identificationDetails" class="identification-details"></div>
            </div>
        </div>

        <div class="divider">
            <span>OR ENTER MANUALLY</span>
        </div>

        <div class="input-group">
            <div class="input-wrapper field-with-help" style="position: relative;">
                <span class="input-icon">üîç</span>
                <input type="text" id="cardQuery" placeholder="Enter card name (or use üé§ voice)" style="padding-right: 60px;">
                <button class="mic-button" id="micButton" onclick="toggleVoiceInput()" title="Voice input">
                    üé§
                </button>
                <div class="help-icon">
                    ?
                    <div class="help-tooltip">
                        <div class="help-tooltip-title">Card Search</div>
                        <div class="help-tooltip-text">Type or use voice üé§ to enter: player name, year, brand, set, parallel, grade. Example: "2024 Panini Prizm Silver Travis Hunter PSA 10"</div>
                    </div>
                </div>
            </div>

            <div class="input-wrapper field-with-help">
                <span class="input-icon">üéØ</span>
                <input type="text" id="exactMatch" placeholder="Exact match words (optional, e.g., #141 Yellow Border)">
                <div class="help-icon">
                    ?
                    <div class="help-tooltip">
                        <div class="help-tooltip-title">Exact Match Filter</div>
                        <div class="help-tooltip-text">Filter results to ONLY show listings containing these exact words. Use for card numbers (#141), specific parallels (Pink Mosaic), or variations (SSP). Helps eliminate similar cards.</div>
                    </div>
                </div>
            </div>
            
            <button class="search-button" onclick="handleSearch()">Analyze Deal</button>
        </div>

        <div id="errorMessage" class="error-message hidden"></div>
        <div id="loadingState" class="loading-state hidden">
            <div class="spinner"></div>
            <p>Analyzing card with AI...</p>
        </div>
        <div id="resultsSection" class="results-section hidden"></div>

        <!-- Add to Batch button (shows after a search in batch mode) -->
        <button id="addToBatchBtn" class="add-to-batch-btn hidden" onclick="addCurrentToBatch()">
            Ôºã Add to Batch
        </button>
    </div>

    <!-- Batch Tray (fixed at bottom when batch mode is on and has items) -->
    <div id="batchTray" class="batch-tray hidden">
        <div class="batch-tray-header">
            <span class="batch-tray-title">üì¶ Batch</span>
            <span class="batch-tray-count" id="batchCount">0 cards</span>
            <button class="batch-tray-expand" id="batchExpandBtn" onclick="toggleBatchExpand()">‚ñ≤</button>
        </div>

        <!-- Expanded view -->
        <div id="batchExpanded" class="batch-expanded hidden">
            <div id="batchItemsList" class="batch-items-list"></div>
            <div class="batch-summary" id="batchSummary">
                <div class="batch-summary-row">
                    <span>Total Avg Value</span>
                    <span id="batchTotalValue">$0.00</span>
                </div>
                <div class="batch-summary-row">
                    <span>Total Suggested Max Pay</span>
                    <span id="batchTotalSuggested">$0.00</span>
                </div>
                <div class="batch-summary-row highlight">
                    <span>Pay No More Than</span>
                    <span id="batchMaxPay">$0.00</span>
                </div>
            </div>
            <button class="batch-clear-btn" onclick="clearBatch()">Clear All</button>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal-overlay">
        <div class="settings-modal-content">
            <div class="modal-header">
                <h2>Cost Settings</h2>
                <button class="close-button" onclick="closeSettings()">√ó</button>
            </div>
            
            <div class="settings-body">
                <div class="settings-section">
                    <h3>Selling Fees</h3>
                    <div class="setting-item">
                        <label>Seller Fee %</label>
                        <input type="number" step="0.01" id="ebayFeePercent" value="13.25">
                    </div>
                    <div class="setting-item">
                        <label>Processor Fee %</label>
                        <input type="number" step="0.01" id="paymentFeePercent" value="0.00">
                    </div>
                    <div class="setting-item">
                        <label>Processor Fee Charge $</label>
                        <input type="number" step="0.01" id="processorFeeCharge" value="0.30">
                    </div>
                </div>

                <div class="settings-section">
                    <h3>Supply & Other Costs ($)</h3>
                    <div class="setting-item">
                        <label>Supply Cost 1 ($)</label>
                        <input type="number" step="0.01" id="supplyCost1" value="0.25">
                    </div>
                    <div class="setting-item">
                        <label>Supply Cost 2 ($)</label>
                        <input type="number" step="0.01" id="supplyCost2" value="0.05">
                    </div>
                    <div class="setting-item">
                        <label>Supply Cost 3 ($)</label>
                        <input type="number" step="0.01" id="supplyCost3" value="0.15">
                    </div>
                    <div class="setting-item">
                        <label>Shipping Cost ($)</label>
                        <input type="number" step="0.01" id="shipping" value="0.00">
                    </div>
                    <div class="setting-item">
                        <label>Additional Costs ($)</label>
                        <input type="number" step="0.01" id="additionalCosts" value="0.00">
                    </div>
                </div>

                <div class="settings-section">
                    <h3>Profit Target</h3>
                    <div class="setting-item">
                        <label>Profit Margin %</label>
                        <input type="number" step="1" id="profitMargin" value="20">
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button class="reset-button" onclick="resetSettings()">Reset to Defaults</button>
                <button class="save-button" onclick="saveSettings()">üíæ Save Settings</button>
            </div>
        </div>
    </div>

    <!-- Camera Modal -->
    <div id="cameraModal" class="modal-overlay">
        <div class="camera-content">
            <div class="camera-header">
                <h3 id="cameraTitle">Take Photo</h3>
                <button class="close-button" onclick="stopCamera()">√ó</button>
            </div>
            <video id="cameraVideo" autoplay playsinline class="camera-video"></video>
            <canvas id="canvas" class="hidden"></canvas>
            <div class="camera-controls">
                <button class="capture-button" onclick="capturePhoto()">
                    <span>üì∑</span>
                    <span>Capture Photo</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        let cardPhotos = { front: null, back: null };
        let currentPhotoSide = null;
        let stream = null;
        let cardIdentification = null;

        // Configuration
        const USE_REAL_EBAY_API = true;

        const costSettings = {
            ebayFeePercent: 13.25,
            paymentFeePercent: 0.00,        // Changed to 0.00 (Processor Fee %)
            processorFeeCharge: 0.30,       // Keep at 0.30 (Processor Fee Charge $)
            supplyCost1: 0.25,
            supplyCost2: 0.05,
            supplyCost3: 0.15,
            shipping: 0.00,
            additionalCosts: 0.00,
            profitMargin: 20
        };

        function updatePhotoButtons() {
            const hasPhotos = cardPhotos.front || cardPhotos.back;
            const aiButton = document.getElementById('aiAnalyzeButton');
            
            if (hasPhotos) {
                aiButton.classList.remove('hidden');
                aiButton.disabled = false;
            } else {
                aiButton.classList.add('hidden');
            }
        }

        function openSettings() {
            // Load current settings into form
            document.getElementById('ebayFeePercent').value = costSettings.ebayFeePercent;
            document.getElementById('paymentFeePercent').value = costSettings.paymentFeePercent;
            document.getElementById('processorFeeCharge').value = costSettings.processorFeeCharge;
            document.getElementById('supplyCost1').value = costSettings.supplyCost1;
            document.getElementById('supplyCost2').value = costSettings.supplyCost2;
            document.getElementById('supplyCost3').value = costSettings.supplyCost3;
            document.getElementById('shipping').value = costSettings.shipping;
            document.getElementById('additionalCosts').value = costSettings.additionalCosts;
            document.getElementById('profitMargin').value = costSettings.profitMargin;
            
            document.getElementById('settingsModal').classList.add('active');
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.remove('active');
        }

        function saveSettings() {
            // Update costSettings from form
            costSettings.ebayFeePercent = parseFloat(document.getElementById('ebayFeePercent').value) || 13.25;
            costSettings.paymentFeePercent = parseFloat(document.getElementById('paymentFeePercent').value) || 3.0;
            costSettings.processorFeeCharge = parseFloat(document.getElementById('processorFeeCharge').value) || 0.30;
            costSettings.supplyCost1 = parseFloat(document.getElementById('supplyCost1').value) || 0;
            costSettings.supplyCost2 = parseFloat(document.getElementById('supplyCost2').value) || 0;
            costSettings.supplyCost3 = parseFloat(document.getElementById('supplyCost3').value) || 0;
            costSettings.shipping = parseFloat(document.getElementById('shipping').value) || 0;
            costSettings.additionalCosts = parseFloat(document.getElementById('additionalCosts').value) || 0;
            costSettings.profitMargin = parseFloat(document.getElementById('profitMargin').value) || 15;
            localStorage.setItem('cardAppCostSettings', JSON.stringify(costSettings));
            
            closeSettings();
            
            // Show success message briefly
            const badge = document.getElementById('apiBadge');
            const originalText = badge.textContent;
            badge.textContent = '‚úì Settings Saved!';
            badge.style.background = 'rgba(16, 185, 129, 0.3)';
            badge.style.borderColor = '#10b981';
            
            setTimeout(() => {
                badge.textContent = originalText;
                badge.style.background = '';
                badge.style.borderColor = '';
            }, 2000);
        }

        function resetSettings() {
            if (confirm('Reset all cost settings to defaults?')) {
                document.getElementById('ebayFeePercent').value = 13.25;
                document.getElementById('paymentFeePercent').value = 3.00;
                document.getElementById('processorFeeCharge').value = 0.30;
                document.getElementById('supplyCost1').value = 0.50;
                document.getElementById('supplyCost2').value = 0.05;
                document.getElementById('supplyCost3').value = 0.15;
                document.getElementById('shipping').value = 5.00;
                document.getElementById('additionalCosts').value = 0.00;
                document.getElementById('profitMargin').value = 15;
            }
        }

        async function startCamera(side) {
            currentPhotoSide = side;
            const modal = document.getElementById('cameraModal');
            const video = document.getElementById('cameraVideo');
            const title = document.getElementById('cameraTitle');
            
            title.textContent = `Take Photo - ${side === 'front' ? 'Front' : 'Back'} of Card`;
            modal.classList.add('active');

            try {
                stream = await navigator.mediaDevices.getUserMedia({
                    video: { 
                        facingMode: 'environment',
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    }
                });
                video.srcObject = stream;
            } catch (err) {
                showError('Unable to access camera. Please check permissions.');
                stopCamera();
            }
        }

        function capturePhoto() {
            const video = document.getElementById('cameraVideo');
            const canvas = document.getElementById('canvas');
            const context = canvas.getContext('2d');

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);

            const photoData = canvas.toDataURL('image/jpeg', 0.9);
            cardPhotos[currentPhotoSide] = photoData;

            // Update UI
            const preview = document.getElementById(`${currentPhotoSide}PhotoPreview`);
            const button = document.getElementById(`${currentPhotoSide}CameraButton`);
            const img = document.getElementById(`${currentPhotoSide}PhotoImg`);
            
            img.src = photoData;
            preview.classList.remove('hidden');
            button.classList.add('hidden');

            updatePhotoButtons();
            stopCamera();
        }

        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            document.getElementById('cameraModal').classList.remove('active');
            currentPhotoSide = null;
        }

        function removePhoto(side) {
            cardPhotos[side] = null;
            document.getElementById(`${side}PhotoPreview`).classList.add('hidden');
            document.getElementById(`${side}CameraButton`).classList.remove('hidden');
            
            // Clear identification if photos are removed
            if (side === 'front' || (side === 'back' && !cardPhotos.front)) {
                cardIdentification = null;
                document.getElementById('cardIdentification').classList.add('hidden');
                document.getElementById('cardQuery').value = '';
            }
            
            updatePhotoButtons();
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // FILE UPLOAD HANDLING - Alternative to camera
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        function selectPhotoFile(side) {
            // Trigger the hidden file input
            document.getElementById(side + 'FileInput').click();
        }

        // Setup file input listeners when page loads
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('frontFileInput').addEventListener('change', function(e) {
                handleFileSelection('front', e.target.files[0]);
            });
            
            document.getElementById('backFileInput').addEventListener('change', function(e) {
                handleFileSelection('back', e.target.files[0]);
            });
        });

        function handleFileSelection(side, file) {
            if (!file) return;
            
            // Validate file type
            if (!file.type.startsWith('image/')) {
                showError('Please select an image file');
                return;
            }
            
            console.log(`üìÅ Loading ${side} photo from file...`);
            
            // Read the file
            const reader = new FileReader();
            reader.onload = function(e) {
                const photoData = e.target.result;
                cardPhotos[side] = photoData;
                
                // Update UI
                const preview = document.getElementById(side + 'PhotoPreview');
                const button = document.getElementById(side + 'CameraButton');
                const img = document.getElementById(side + 'PhotoImg');
                
                img.src = photoData;
                preview.classList.remove('hidden');
                button.classList.add('hidden');
                
                updatePhotoButtons();
                
                console.log(`‚úÖ ${side} photo loaded successfully`);
            };
            
            reader.onerror = function() {
                showError('Failed to read image file. Please try again.');
            };
            
            reader.readAsDataURL(file);
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // IMAGE PREPROCESSING - Enhances card photos for better AI reading
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        /**
         * Enhance image quality before sending to AI
         * Increases contrast and brightness to make small text readable on card backs
         * @param {string} imageDataUrl - Base64 image data URL
         * @returns {Promise<string>} - Enhanced base64 image data URL
         */
        async function enhanceImageForAI(imageDataUrl) {
            if (!imageDataUrl) return null;
            
            return new Promise((resolve) => {
                const img = new Image();
                
                img.onload = () => {
                    try {
                        // Create canvas for image processing
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        // Set canvas size to match image
                        canvas.width = img.width;
                        canvas.height = img.height;
                        
                        // Apply enhancement filters
                        // contrast(1.4) = 40% more contrast for text clarity
                        // brightness(1.2) = 20% brighter for dark photos
                        // saturate(1.1) = 10% more saturation to make colors pop
                        ctx.filter = 'contrast(1.4) brightness(1.2) saturate(1.1)';
                        ctx.drawImage(img, 0, 0);
                        
                        // Convert back to data URL with high quality
                        const enhanced = canvas.toDataURL('image/jpeg', 0.95);
                        
                        console.log('‚úÖ Image enhanced successfully');
                        resolve(enhanced);
                    } catch (error) {
                        console.error('Image enhancement failed:', error);
                        // If enhancement fails, return original image
                        resolve(imageDataUrl);
                    }
                };
                
                img.onerror = () => {
                    console.error('Failed to load image for enhancement');
                    resolve(imageDataUrl); // Return original if loading fails
                };
                
                img.src = imageDataUrl;
            });
        }
        async function identifyCardFromImage(frontImage, backImage) {
            try {
                console.log('üé® Starting card identification with image enhancement...');
                
                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                // NEW: Enhance images before sending to AI for better accuracy
                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                const enhancedFront = frontImage ? await enhanceImageForAI(frontImage) : null;
                const enhancedBack = backImage ? await enhanceImageForAI(backImage) : null;
                
                console.log('‚ú® Images enhanced! Sending to AI worker...');
                
                // Call our Cloudflare AI worker with enhanced photos
                const requestBody = {};
                if (enhancedFront) requestBody.frontImage = enhancedFront;
                if (enhancedBack) requestBody.backImage = enhancedBack;
                
                const response = await fetch("https://card-ai.cgrayut.workers.dev", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to identify card');
                }

                const cardInfo = await response.json();
                
                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                // NEW: Enhanced logging for debugging
                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                console.log('üîç AI Analysis Complete:');
                console.log('  Player:', cardInfo.player);
                console.log('  Year:', cardInfo.year);
                console.log('  Brand:', cardInfo.brand);
                console.log('  Set:', cardInfo.set);
                console.log('  Card #:', cardInfo.cardNumber);
                console.log('  Confidence:', cardInfo.confidence);
                
                // NEW: Log diagnostic info if available
                if (cardInfo.whatICanSee) {
                    console.log('  What AI Can See:', cardInfo.whatICanSee);
                }
                if (cardInfo.notes) {
                    console.log('  AI Notes:', cardInfo.notes);
                }
                
                return cardInfo;
                
            } catch (err) {
                console.error('‚ùå Card identification error:', err);
                // Show actual error details
                const errorMsg = 'Actual error: ' + err.message + ' | Stack: ' + (err.stack || 'no stack');
                throw new Error(errorMsg);
            }
        }

        // Demo card data for when AI API is unavailable
        const demoCards = [
            { player: "Ja Morant", year: "2023", brand: "Panini", set: "Prizm", parallel: "Silver", grade: "PSA 10", sport: "Basketball", searchQuery: "2023 Panini Prizm Ja Morant Silver PSA 10" },
            { player: "Charizard", year: "2023", brand: "Pokemon", set: "Obsidian Flames", parallel: "Full Art", grade: "PSA 10", sport: "Pokemon", searchQuery: "Pokemon Charizard Obsidian Flames Full Art PSA 10" },
            { player: "Tyreek Hill", year: "2022", brand: "Panini", set: "Mosaic", parallel: "Gold", grade: "BGS 9.5", sport: "Football", searchQuery: "2022 Panini Mosaic Tyreek Hill Gold BGS 9.5" },
            { player: "Pikachu", year: "2021", brand: "Pokemon", set: "Evolving Skies", parallel: "Secret Rare", grade: "PSA 9", sport: "Pokemon", searchQuery: "Pokemon Pikachu Evolving Skies Secret Rare PSA 9" },
            { player: "Shohei Ohtani", year: "2023", brand: "Topps", set: "Chrome", parallel: "Refractor", grade: "PSA 10", sport: "Baseball", searchQuery: "2023 Topps Chrome Shohei Ohtani Refractor PSA 10" },
            { player: "Victor Wembanyama", year: "2023", brand: "Panini", set: "Select", parallel: "Rookie", grade: "PSA 10", sport: "Basketball", searchQuery: "2023 Panini Select Victor Wembanyama Rookie PSA 10" },
            { player: "Mewtwo", year: "2022", brand: "Pokemon", set: "Brilliant Stars", parallel: "Ultra Rare", grade: "BGS 10", sport: "Pokemon", searchQuery: "Pokemon Mewtwo Brilliant Stars Ultra Rare BGS 10" },
            { player: "Patrick Mahomes", year: "2021", brand: "Panini", set: "Prizm", parallel: "Silver", grade: "PSA 9", sport: "Football", searchQuery: "2021 Panini Prizm Patrick Mahomes Silver PSA 9" }
        ];
        let demoCardIndex = 0;

        async function analyzeCard() {
            if (!cardPhotos.front && !cardPhotos.back) {
                showError('Please take at least one photo of the card first');
                return;
            }

            hideError();
            showLoading();

            try {
                const photoToAnalyze = cardPhotos.front || cardPhotos.back;
                
                // Check if photo data exists
                if (!photoToAnalyze || !photoToAnalyze.startsWith('data:image')) {
                    alert('Photo data invalid! Length: ' + (photoToAnalyze ? photoToAnalyze.length : 0));
                    throw new Error('Invalid photo data');
                }
                
                let identified = null;

                try {
                    // NEW: Pass both front AND back images for better analysis
                    identified = await identifyCardFromImage(cardPhotos.front, cardPhotos.back);
                } catch (aiErr) {
                    // Show error on mobile
                    alert('AI Error: ' + aiErr.message);
                    console.error('AI identification failed:', aiErr);
                    // AI API unavailable ‚Äî use rotating demo card
                    identified = demoCards[demoCardIndex % demoCards.length];
                    demoCardIndex++;
                }

                cardIdentification = identified;
                
                // Display identification
                displayCardIdentification(cardIdentification);
                
                // Populate the search field (but don't search yet!)
                document.getElementById('cardQuery').value = cardIdentification.searchQuery;
                
                // Hide the AI button, show a success message
                document.getElementById('aiAnalyzeButton').classList.add('hidden');
                
                // Scroll to the manual entry section so user can review/edit
                document.getElementById('cardQuery').scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                // Show info message
                const infoDiv = document.createElement('div');
                infoDiv.className = 'info-message';
                infoDiv.innerHTML = '<span>‚úì</span> Card identified! Review the details above and click "Analyze Deal" when ready.';
                document.getElementById('cardIdentification').appendChild(infoDiv);
                
            } catch (err) {
                showError(err.message);
            } finally {
                hideLoading();
            }
        }

        function displayCardIdentification(info) {
            const container = document.getElementById('identificationDetails');
            container.innerHTML = '';
            
            const fields = [
                { label: 'Player', value: info.player },
                { label: 'Year', value: info.year },
                { label: 'Brand', value: info.brand },
                { label: 'Set', value: info.set },
                { label: 'Card #', value: info.cardNumber },
                { label: 'Parallel', value: info.parallel },
                { label: 'Grade', value: info.grade }
            ];
            
            fields.forEach(field => {
                // Show all fields, even if Unknown (user can edit them)
                const item = document.createElement('div');
                item.className = 'id-item';
                item.innerHTML = `
                    <span class="id-label">${field.label}:</span>
                    <span class="id-value">${field.value || 'Unknown'}</span>
                `;
                container.appendChild(item);
            });
            
            document.getElementById('cardIdentification').classList.remove('hidden');
        }

        async function handleSearch() {
            const cardQuery = document.getElementById('cardQuery').value;
            const sellerPrice = document.getElementById('sellerPrice').value;
            
            if (!cardQuery) {
                showError('Please enter a card name or take a photo');
                return;
            }
            
            hideError();
            showLoading();
            
            try {
                await performSearch(cardQuery, sellerPrice);
            } catch (err) {
                showError(err.message);
            } finally {
                hideLoading();
            }
        }

        async function fetchEbaySoldItems(keywords) {
            try {
                // Your Cloudflare Worker URL
                const WORKER_URL = 'https://ebay-proxy.cgrayut.workers.dev';
                
                // Call your Cloudflare Worker instead of eBay directly
                const url = `${WORKER_URL}?keywords=${encodeURIComponent(keywords)}&sandbox=false`;

                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`Worker API error: ${response.status}`);
                }

                const data = await response.json();
                
                // Check for errors from the worker
                if (data.error) {
                    throw new Error(data.error);
                }
                
                const searchResult = data.findCompletedItemsResponse?.[0]?.searchResult?.[0];
                
                if (!searchResult || searchResult['@count'] === '0') {
                    return null;
                }

                const items = searchResult.item || [];
                
                const salesData = items
                    .filter(item => {
                        return item.sellingStatus?.[0]?.sellingState?.[0] === 'EndedWithSales';
                    })
                    .map(item => {
                        const price = parseFloat(item.sellingStatus[0].currentPrice[0].__value__);
                        const endTime = item.listingInfo[0].endTime[0];
                        const condition = item.condition?.[0]?.conditionDisplayName?.[0] || 'Unknown';
                        const title = item.title[0];
                        const imageURL = item.galleryURL?.[0] || item.pictureURL?.[0] || '';
                        
                        const date = new Date(endTime).toLocaleDateString('en-US', {
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit'
                        });
                        
                        return { price, date, condition, title, imageURL };
                    })
                    .filter(item => item.price > 0);

                return salesData;

            } catch (error) {
                console.error('eBay API Error:', error);
                throw error;
            }
        }

        async function performSearch(query, price) {
            let salesData;
            
            if (USE_REAL_EBAY_API) {
                try {
                    // Step 1: Exact search
                    console.log('Calling Apify worker:', query);
                    const response = await fetch(`https://card-value-apify.cgrayut.workers.dev?q=${encodeURIComponent(query)}`);
                    
                    console.log('Apify response status:', response.status);
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('Apify error response:', errorText);
                        throw new Error(`Apify worker returned ${response.status}: ${errorText}`);
                    }
                    
                    const ebayResults = await response.json();
                    console.log('Apify results:', ebayResults.length, 'items');
                    
                    // DEBUG: Log first item to see structure
                    if (ebayResults.length > 0) {
                        console.log('First Apify item structure:', JSON.stringify(ebayResults[0], null, 2));
                    }
                    
                    // Check if results are actually valid
                    if (!Array.isArray(ebayResults)) {
                        console.error('Apify returned non-array:', ebayResults);
                        throw new Error('Apify returned invalid data format');
                    }
                    
                    // Apply exact match filter if provided
                    let filteredResults = ebayResults;
                    const exactMatch = document.getElementById('exactMatch').value.trim();
                    
                    if (exactMatch && ebayResults && ebayResults.length > 0) {
                        // Split exact match into individual words/phrases
                        const exactWords = exactMatch.toLowerCase().split(' ').filter(w => w.length > 0);
                        
                        // Filter results to only include listings that contain ALL exact match words
                        filteredResults = ebayResults.filter(item => {
                            const title = (item.title || '').toLowerCase();
                            return exactWords.every(word => title.includes(word));
                        });
                        
                        console.log(`Exact match filter: ${exactMatch}`);
                        console.log(`Results before filter: ${ebayResults.length}, after filter: ${filteredResults.length}`);
                    }
                    
                    // If we found ANY results for the exact card, use them
                    if (filteredResults && filteredResults.length > 0) {
                        salesData = {
                            cardName: query,
                            recentSales: filteredResults.slice(0, 10),
                            searchType: exactMatch ? 'Exact Match (Filtered)' : 'Exact Match'
                        };
                    } else {
                        // Step 2: NO exact results found, try Priority 1 fallback
                        const cardParts = parseCardQuery(query);
                        const fallbackSearch1 = buildFallbackSearch(cardParts, 1);
                        
                        if (fallbackSearch1) {
                            const results1 = await fetchEbaySoldItems(fallbackSearch1.query);
                            
                            if (results1 && results1.length > 0) {
                                salesData = {
                                    cardName: query,
                                    recentSales: results1.slice(0, 10),
                                    searchType: fallbackSearch1.type,
                                    comparableQuery: fallbackSearch1.query
                                };
                            } else {
                                // Step 3: Priority 1 failed, try Priority 2 fallback
                                const fallbackSearch2 = buildFallbackSearch(cardParts, 2);
                                
                                if (fallbackSearch2) {
                                    const results2 = await fetchEbaySoldItems(fallbackSearch2.query);
                                    
                                    if (results2 && results2.length > 0) {
                                        salesData = {
                                            cardName: query,
                                            recentSales: results2.slice(0, 10),
                                            searchType: fallbackSearch2.type,
                                            comparableQuery: fallbackSearch2.query
                                        };
                                    }
                                }
                            }
                        }
                        
                        // If still no results, use mock data
                        if (!salesData) {
                            throw new Error('No sales data found for exact card or comparable cards');
                        }
                    }
                } catch (err) {
                    console.error('eBay API Error:', err);
                    // Show detailed error to user
                    showError(`eBay search failed: ${err.message}. Using demo data. Check Cloudflare worker logs.`);
                    salesData = generateMockData(query);
                    salesData.searchType = 'Demo Mode (API Error)';
                    salesData.comparableQuery = err.message || 'API call failed';
                }
            } else {
                await new Promise(resolve => setTimeout(resolve, 1500));
                salesData = generateMockData(query);
            }
            
            const metrics = calculateMetrics(salesData, price);
            displayResults(salesData, metrics);
        }

        /**
         * Parse card query into components
         */
        function parseCardQuery(query) {
            const parts = {
                year: query.match(/\b(19|20)\d{2}\b/)?.[0] || '',
                brand: extractBrand(query),
                set: extractSet(query),
                player: extractPlayer(query),
                grade: query.match(/(PSA|BGS|SGC)\s*\d+/i)?.[0] || '',
                parallel: extractParallel(query),
                sport: extractSport(query)
            };
            return parts;
        }

        /**
         * Extract brand from query
         */
        function extractBrand(query) {
            const brands = [
                // Sports card brands
                'Panini', 'Topps', 'Upper Deck', 'Bowman', 'Donruss', 'Fleer', 'Select', 'Score', 'Leaf', 'SP Authentic',
                // Pok√©mon brands
                'Pokemon', 'Pok√©mon', 'PTCG', 'Wizards of the Coast', 'WotC'
            ];
            for (const brand of brands) {
                if (query.toLowerCase().includes(brand.toLowerCase())) {
                    return brand;
                }
            }
            return '';
        }

        /**
         * Extract set name from query
         */
        function extractSet(query) {
            const sets = [
                // Sports card sets
                'Prizm', 'Chrome', 'Optic', 'Mosaic', 'Select', 'Contenders', 'Certified', 'Crown Royale', 'National Treasures', 'Immaculate',
                // Pok√©mon sets
                'Base Set', 'Jungle', 'Fossil', 'Team Rocket', 'Gym Heroes', 'Gym Challenge',
                'Neo Genesis', 'Neo Discovery', 'Neo Revelation', 'Neo Destiny',
                'Legendary Collection', 'Expedition', 'Aquapolis', 'Skyridge',
                'EX Ruby & Sapphire', 'EX FireRed & LeafGreen', 'EX Emerald',
                'Diamond & Pearl', 'Platinum', 'HeartGold & SoulSilver',
                'Black & White', 'XY', 'Sun & Moon', 'Sword & Shield', 'Scarlet & Violet',
                'Evolving Skies', 'Brilliant Stars', 'Astral Radiance', 'Lost Origin',
                'Silver Tempest', 'Crown Zenith', 'Paldea Evolved', 'Obsidian Flames',
                '151', 'Paradox Rift', 'Paldean Fates', 'Temporal Forces'
            ];
            
            // Check longer names first to avoid partial matches
            const sortedSets = sets.sort((a, b) => b.length - a.length);
            
            for (const set of sortedSets) {
                const regex = new RegExp(`\\b${set}\\b`, 'i');
                if (regex.test(query)) {
                    return set;
                }
            }
            return '';
        }

        /**
         * Extract player/Pok√©mon name (improved accuracy)
         */
        function extractPlayer(query) {
            // Remove known keywords to isolate player/Pok√©mon name
            let cleaned = query
                // Remove years
                .replace(/\b(19|20)\d{2}\b/g, '')
                // Remove grades
                .replace(/PSA|BGS|SGC|CGC\s*\d+(\.\d+)?/gi, '')
                // Remove sports card brands
                .replace(/Panini|Topps|Upper Deck|Bowman|Donruss|Fleer|Score|Leaf|SP Authentic/gi, '')
                // Remove Pok√©mon brands
                .replace(/Pokemon|Pok√©mon|PTCG|Wizards of the Coast|WotC/gi, '')
                // Remove sports card sets
                .replace(/Prizm|Chrome|Optic|Mosaic|Select|Contenders|Certified|Crown Royale|National Treasures|Immaculate/gi, '')
                // Remove Pok√©mon sets
                .replace(/Base Set|Jungle|Fossil|Team Rocket|Gym Heroes|Gym Challenge|Neo Genesis|Neo Discovery|Neo Revelation|Neo Destiny/gi, '')
                .replace(/Legendary Collection|Expedition|Aquapolis|Skyridge|Diamond & Pearl|Platinum|HeartGold|SoulSilver/gi, '')
                .replace(/Black & White|Sword & Shield|Scarlet & Violet|Evolving Skies|Brilliant Stars|Crown Zenith|Paldea Evolved/gi, '')
                .replace(/Obsidian Flames|Paradox Rift|Paldean Fates|Temporal Forces/gi, '')
                // Remove parallels and card types (sports)
                .replace(/Silver|Gold|Base|Orange|Red|Blue|Green|Purple|Pink|Ruby|Sapphire|Emerald/gi, '')
                .replace(/Refractor|Shimmer|Tiger Stripe|Zebra|Camo|Cracked Ice|Fast Break|Hyper|Neon|Disco/gi, '')
                // Remove Pok√©mon card types
                .replace(/Holo|Reverse Holo|Reverse|Full Art|Secret Rare|Ultra Rare|Rainbow Rare|Gold Secret/gi, '')
                .replace(/Hyper Rare|Special Art Rare|Illustration Rare|Double Rare|Shiny Rare|Amazing Rare|Radiant/gi, '')
                .replace(/VMAX|VSTAR|BREAK|Prime|Legend/gi, '')
                .replace(/\bV\b|\bGX\b|\bEX\b|\bex\b/gi, '') // Single letter types
                // Remove card attributes
                .replace(/Rookie|RC|Auto|Autograph|Jersey|Patch|Memorabilia|Relic|Numbered|Parallel/gi, '')
                .replace(/1st Edition|Shadowless|Unlimited|Stamped/gi, '')
                .replace(/\/#?\d+/g, '') // Remove card numbers like /99 or #42
                // Clean up extra spaces
                .replace(/\s+/g, ' ')
                .trim();
            
            // Take the first 2-4 words as likely player/Pok√©mon name
            const words = cleaned.split(' ').filter(w => w.length > 1); // Allow 2-letter names
            
            // Most names are 1-3 words (Charizard, Ja Morant, Patrick Mahomes)
            const nameLength = Math.min(4, words.length);
            return words.slice(0, nameLength).join(' ');
        }

        /**
         * Extract parallel type (color, variation, insert type)
         * Includes both sports card parallels and Pok√©mon card types
         */
        function extractParallel(query) {
            const parallels = [
                // Sports card parallels
                'Silver', 'Gold', 'Base', 'Orange', 'Red', 'Blue', 'Green', 'Purple', 'Pink',
                'Refractor', 'Chrome', 'Shimmer', 'Holo', 'Prizm',
                'Black', 'White', 'Ruby', 'Sapphire', 'Emerald',
                'Tiger Stripe', 'Zebra', 'Camo', 'Mosaic', 'Cracked Ice',
                'Fast Break', 'Hyper', 'Neon', 'Disco', 'Wave',
                'Ice', 'Fire', 'Scope', 'Lazer', 'Nebula',
                // Pok√©mon card types
                'Holo', 'Reverse Holo', 'Reverse', 'Full Art', 'Secret Rare', 'Ultra Rare',
                'Rainbow Rare', 'Gold Secret', 'Hyper Rare', 'Special Art Rare', 'Illustration Rare',
                'Double Rare', 'Shiny', 'Shiny Rare', 'Amazing Rare', 'Radiant',
                'V', 'VMAX', 'VSTAR', 'GX', 'EX', 'ex', 'Prime', 'Legend', 'BREAK',
                '1st Edition', 'Shadowless', 'Unlimited', 'Stamped'
            ];
            
            // Look for parallels, checking longer names first
            const sortedParallels = parallels.sort((a, b) => b.length - a.length);
            
            for (const parallel of sortedParallels) {
                const regex = new RegExp(`\\b${parallel}\\b`, 'i');
                if (regex.test(query)) {
                    return parallel;
                }
            }
            return '';
        }

        /**
         * Determine sport/card type from context
         */
        function extractSport(query) {
            const lower = query.toLowerCase();
            
            // Check for Pok√©mon
            if (lower.includes('pokemon') || lower.includes('pok√©mon') || lower.includes('pikachu') || 
                lower.includes('charizard') || lower.includes('ptcg') || lower.includes('tcg')) {
                return 'Pokemon';
            }
            
            // Check for sports
            if (lower.includes('nba') || lower.includes('basketball')) return 'Basketball';
            if (lower.includes('nfl') || lower.includes('football')) return 'Football';
            if (lower.includes('mlb') || lower.includes('baseball')) return 'Baseball';
            if (lower.includes('nhl') || lower.includes('hockey')) return 'Hockey';
            
            return '';
        }

        /**
         * Build fallback search based on priority level:
         * Priority 1: EXACT same card characteristics, different player
         * Priority 2: SAME player, similar card characteristics
         */
        function buildFallbackSearch(parts, priority) {
            if (priority === 1) {
                // Priority 1: Match ALL card characteristics EXCEPT player
                // Goal: Find what similar players' identical cards sell for
                
                let searchParts = [];
                
                if (parts.year) searchParts.push(parts.year);
                if (parts.brand) searchParts.push(parts.brand);
                if (parts.set) searchParts.push(parts.set);
                if (parts.parallel) searchParts.push(parts.parallel);
                if (parts.grade) searchParts.push(parts.grade);
                
                // Must have at least brand + set to be meaningful
                if (searchParts.length >= 2) {
                    return {
                        type: 'Same Card Type - Different Players',
                        query: searchParts.join(' ').trim()
                    };
                }
            } else if (priority === 2) {
                // Priority 2: Same player, match similar characteristics
                // Goal: Find comparable cards of the same player
                
                if (!parts.player) return null;
                
                let searchParts = [parts.player]; // Player is required
                
                // Add characteristics in order of importance
                if (parts.brand) searchParts.push(parts.brand);
                if (parts.year) searchParts.push(parts.year);
                if (parts.set) searchParts.push(parts.set);
                // Intentionally skip parallel and grade to broaden search
                
                return {
                    type: 'Same Player - Similar Cards',
                    query: searchParts.join(' ').trim()
                };
            }
            
            return null;
        }

        function generateMockData(query) {
            const basePrice = 45;
            const variance = 8;
            
            const mockTitles = [
                `${query} - Sold Listing`,
                `${query} Near Mint`,
                `${query} PSA Graded`,
                `${query} Authentic`,
                `${query} Great Condition`,
                `${query} Factory Sealed`,
                `${query} Mint Card`,
                `${query} Verified`,
                `${query} Premium`,
                `${query} Collector Edition`
            ];
            
            return {
                cardName: query,
                recentSales: Array.from({ length: 10 }, (_, i) => ({
                    price: basePrice + (Math.random() * variance * 2 - variance),
                    date: new Date(Date.now() - i * 86400000).toLocaleDateString('en-US'),
                    condition: ['Mint', 'Near Mint', 'Excellent', 'Very Good'][Math.floor(Math.random() * 4)],
                    title: mockTitles[i],
                    imageURL: 'https://i.ebayimg.com/images/g/placeholder/s-l140.jpg'
                }))
            };
        }

        function calculateMetrics(salesData, sellerPrice) {
            const prices = salesData.recentSales.map(sale => sale.price);
            const average = prices.reduce((a, b) => a + b, 0) / prices.length;
            const sortedPrices = [...prices].sort((a, b) => a - b);
            const median = sortedPrices[Math.floor(sortedPrices.length / 2)];
            const high = Math.max(...prices);
            const low = Math.min(...prices);
            
            const ebayFee = average * (costSettings.ebayFeePercent / 100);
            const paymentFee = (average * (costSettings.paymentFeePercent / 100)) + costSettings.processorFeeCharge;
            const supplyCosts = costSettings.supplyCost1 + costSettings.supplyCost2 + 
                               costSettings.supplyCost3 + costSettings.additionalCosts;
            const shipping = costSettings.shipping;
            const totalCosts = ebayFee + paymentFee + supplyCosts + shipping;
            
            const netProceeds = average - totalCosts;
            // Suggested price: What you should pay to achieve target profit margin
            // Formula: netProceeds / (1 + profitMargin/100)
            const suggestedPrice = netProceeds / (1 + (costSettings.profitMargin / 100));
            
            // These only apply if seller price is provided
            const hasPurchasePrice = sellerPrice && parseFloat(sellerPrice) > 0;
            let purchasePrice, potentialProfit, roi, recommendation;
            
            if (hasPurchasePrice) {
                purchasePrice = parseFloat(sellerPrice);
                potentialProfit = average - (purchasePrice + totalCosts);
                roi = ((potentialProfit / purchasePrice) * 100).toFixed(1);
                
                const isPriceGood = purchasePrice <= suggestedPrice;
                const isPriceOk = purchasePrice <= netProceeds * 0.95;
                
                if (isPriceGood) {
                    recommendation = { status: 'buy', message: 'Strong Buy - Great deal!' };
                } else if (isPriceOk) {
                    recommendation = { status: 'consider', message: 'Fair Price - Consider market trends' };
                } else {
                    recommendation = { status: 'pass', message: 'Overpriced - Pass on this deal' };
                }
            }
            
            return {
                average: average.toFixed(2),
                median: median.toFixed(2),
                high: high.toFixed(2),
                low: low.toFixed(2),
                suggestedPrice: suggestedPrice.toFixed(2),
                netProceeds: netProceeds.toFixed(2),
                totalCosts: totalCosts.toFixed(2),
                roi: hasPurchasePrice ? roi : null,
                potentialProfit: hasPurchasePrice ? potentialProfit.toFixed(2) : null,
                recommendation: hasPurchasePrice ? recommendation : null,
                salesCount: prices.length,
                hasPurchasePrice
            };
        }

        // Global variables for listing selection and recalculation
        let currentSalesData = null;
        let currentSellerPrice = null;
        let selectedListings = new Set(); // Track which listings are selected

        function displayResults(salesData, metrics) {
            const resultsSection = document.getElementById('resultsSection');
            
            // Store globally for recalculation
            currentSalesData = salesData;
            currentSellerPrice = document.getElementById('sellerPrice').value;
            
            // Initialize all listings as selected
            selectedListings = new Set(salesData.recentSales.map((_, index) => index));
            
            const icon = metrics.recommendation 
                ? (metrics.recommendation.status === 'buy' ? '‚úì' : 
                   metrics.recommendation.status === 'consider' ? '‚ö†' : '‚úó')
                : '';
            
            // Show info message if using comparable cards or demo mode
            const comparableMessage = salesData.searchType === 'Demo Mode'
                ? `<div class="info-message">
                    <span>‚ÑπÔ∏è</span>
                    ${salesData.searchType === 'Demo Mode' || salesData.searchType === 'Demo Mode (API Error)' ? 'DEMO DATA - Apify returned no results or worker error occurred' : 'Live eBay Data'}
                   </div>`
                : salesData.searchType && salesData.searchType !== 'Exact Match' 
                    ? `<div class="info-message">
                        <span>‚ÑπÔ∏è</span>
                        Exact card not found. Showing ${salesData.searchType}: "${salesData.comparableQuery}"
                       </div>` 
                    : '';
            
            // Build sold listings HTML with checkboxes
            const listingsHTML = salesData.recentSales.map((sale, index) => {
                // Handle multiple possible image field names
                const imageUrl = sale.imageURL || sale.image || sale.galleryURL || sale.pictureURL || '';
                
                // Handle multiple possible URL field names
                const listingUrl = sale.url || sale.itemURL || sale.link || '';
                
                // NEW: If we have a URL but no image, try to extract from eBay
                // eBay item URLs follow pattern: https://www.ebay.com/itm/ITEM_ID
                let displayImageUrl = imageUrl;
                if (!displayImageUrl && listingUrl) {
                    // Extract item ID from URL
                    const itemIdMatch = listingUrl.match(/\/itm\/(\d+)/);
                    if (itemIdMatch && itemIdMatch[1]) {
                        // Use eBay's thumbnail service
                        // Format: https://thumbs.ebayimg.com/images/g/[itemId]/s-l300.png
                        const itemId = itemIdMatch[1];
                        // Try multiple eBay image URL patterns
                        displayImageUrl = `https://thumbs.ebayimg.com/images/g/${itemId}/s-l300.png`;
                    }
                }
                
                return `
                <div class="listing-item" data-listing-index="${index}">
                    <div class="listing-checkbox-wrap">
                        <input type="checkbox" 
                               id="listing-${index}" 
                               class="listing-checkbox" 
                               checked 
                               onchange="toggleListing(${index})">
                    </div>
                    <div class="listing-image-wrap">
                        ${displayImageUrl
                            ? `<img class="listing-image" src="${displayImageUrl}" alt="Sold listing" onerror="this.parentElement.innerHTML='<div class=&quot;listing-image-placeholder&quot;>üì∑</div>'">`
                            : `<div class="listing-image-placeholder">üì∑</div>`
                        }
                    </div>
                    <div class="listing-info">
                        ${listingUrl 
                            ? `<a href="${listingUrl}" target="_blank" rel="noopener noreferrer" class="listing-title-link">${sale.title || 'No title available'}</a>`
                            : `<div class="listing-title">${sale.title || 'No title available'}</div>`
                        }
                        <div class="listing-details">
                            <span class="listing-price">$${sale.price.toFixed(2)}</span>
                            <span class="listing-condition">${sale.condition}</span>
                            <span class="listing-date">${sale.date}</span>
                        </div>
                    </div>
                </div>
            `;
            }).join('');
            
            resultsSection.innerHTML = `
                ${comparableMessage}
                
                ${metrics.hasPurchasePrice ? `
                    <div class="recommendation-badge ${metrics.recommendation.status}">
                        <span>${icon}</span>
                        <span>${metrics.recommendation.message}</span>
                    </div>` : ''}
                
                <div class="metrics-grid">
                    <div class="metric-card primary">
                        <div class="metric-label">Average Sale Price</div>
                        <div class="metric-value">$${metrics.average}</div>
                        <div class="metric-detail">Based on ${metrics.salesCount} recent sales</div>
                    </div>

                    <div class="metric-card">
                        <div class="metric-label">Net Proceeds (After Fees)</div>
                        <div class="metric-value">$${metrics.netProceeds}</div>
                        <div class="metric-detail">Fees: $${metrics.totalCosts}</div>
                    </div>

                    <div class="metric-card">
                        <div class="metric-label">Suggested Purchase Price</div>
                        <div class="metric-value">$${metrics.suggestedPrice}</div>
                        <div class="metric-detail">Allows ${costSettings.profitMargin}% profit margin</div>
                    </div>

                    ${metrics.hasPurchasePrice ? `
                    <div class="metric-card">
                        <div class="metric-label">Realistic ROI</div>
                        <div class="metric-value ${parseFloat(metrics.roi) > 0 ? 'positive' : 'negative'}">
                            ${metrics.roi}%
                        </div>
                        <div class="metric-detail">Profit: $${metrics.potentialProfit}</div>
                    </div>` : ''}
                </div>

                <!-- Sold Listings Section -->
                <div class="listings-section">
                    <div class="listings-header">
                        <div class="listings-title-group">
                            <h3>Recent Sold Listings</h3>
                            <span class="listings-count" id="listingsCount">${salesData.recentSales.length} of ${salesData.recentSales.length} selected</span>
                        </div>
                        <div class="listings-controls">
                            <button class="selection-btn" onclick="selectAllListings()">Select All</button>
                            <button class="selection-btn" onclick="deselectAllListings()">Deselect All</button>
                        </div>
                    </div>
                    <div class="listings-container">
                        ${listingsHTML}
                    </div>
                </div>
            `;
            
            resultsSection.classList.remove('hidden');
            resultsSection.scrollIntoView({ behavior: 'smooth' });

            // Store current result for batch and show/hide Add to Batch button
            currentResult = { salesData, metrics };
            document.getElementById('addToBatchBtn').classList.toggle('hidden', !batchMode);
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = '‚ö† ' + message;
            errorDiv.classList.remove('hidden');
        }

        function hideError() {
            document.getElementById('errorMessage').classList.add('hidden');
        }

        function showLoading() {
            document.getElementById('loadingState').classList.remove('hidden');
            document.getElementById('resultsSection').classList.add('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingState').classList.add('hidden');
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // LISTING SELECTION & RECALCULATION
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        function toggleListing(index) {
            const checkbox = document.getElementById(`listing-${index}`);
            const listingItem = document.querySelector(`[data-listing-index="${index}"]`);
            
            if (checkbox.checked) {
                selectedListings.add(index);
                listingItem.classList.remove('listing-deselected');
            } else {
                selectedListings.delete(index);
                listingItem.classList.add('listing-deselected');
            }
            
            recalculateMetrics();
        }
        
        function selectAllListings() {
            if (!currentSalesData) return;
            
            currentSalesData.recentSales.forEach((_, index) => {
                selectedListings.add(index);
                const checkbox = document.getElementById(`listing-${index}`);
                const listingItem = document.querySelector(`[data-listing-index="${index}"]`);
                if (checkbox) checkbox.checked = true;
                if (listingItem) listingItem.classList.remove('listing-deselected');
            });
            
            recalculateMetrics();
        }
        
        function deselectAllListings() {
            if (!currentSalesData) return;
            
            currentSalesData.recentSales.forEach((_, index) => {
                selectedListings.delete(index);
                const checkbox = document.getElementById(`listing-${index}`);
                const listingItem = document.querySelector(`[data-listing-index="${index}"]`);
                if (checkbox) checkbox.checked = false;
                if (listingItem) listingItem.classList.add('listing-deselected');
            });
            
            recalculateMetrics();
        }
        
        function recalculateMetrics() {
            if (!currentSalesData || selectedListings.size === 0) {
                // No listings selected - show warning
                updateMetricsDisplay(null, 0);
                return;
            }
            
            // Get only selected listings
            const selectedSales = currentSalesData.recentSales.filter((_, index) => 
                selectedListings.has(index)
            );
            
            // Recalculate metrics with only selected listings
            const newMetrics = calculateMetrics(
                { recentSales: selectedSales }, 
                currentSellerPrice
            );
            
            // Update display
            updateMetricsDisplay(newMetrics, selectedSales.length);
            
            // Update count indicator
            const countEl = document.getElementById('listingsCount');
            if (countEl) {
                countEl.textContent = `${selectedSales.length} of ${currentSalesData.recentSales.length} selected`;
            }
        }
        
        function updateMetricsDisplay(metrics, selectedCount) {
            // Update count indicator first
            const countEl = document.getElementById('listingsCount');
            if (countEl) {
                countEl.textContent = `${selectedCount} of ${currentSalesData.recentSales.length} selected`;
            }
            
            if (!metrics || selectedCount === 0) {
                // Show "no selections" message in metrics area only
                const recommendationBadge = document.querySelector('.recommendation-badge');
                const metricsGrid = document.querySelector('.metrics-grid');
                
                if (recommendationBadge) {
                    recommendationBadge.style.display = 'none';
                }
                
                if (metricsGrid) {
                    metricsGrid.innerHTML = `
                        <div class="info-message" style="grid-column: 1 / -1;">
                            <span>‚ö†Ô∏è</span>
                            Please select at least one listing to calculate metrics
                        </div>
                    `;
                }
                return;
            }
            
            // Update recommendation badge
            const icon = metrics.recommendation 
                ? (metrics.recommendation.status === 'buy' ? '‚úì' : 
                   metrics.recommendation.status === 'consider' ? '‚ö†' : '‚úó')
                : '';
            
            const recommendationBadge = document.querySelector('.recommendation-badge');
            if (metrics.hasPurchasePrice && recommendationBadge) {
                recommendationBadge.style.display = 'flex';
                recommendationBadge.className = `recommendation-badge ${metrics.recommendation.status}`;
                recommendationBadge.innerHTML = `
                    <span>${icon}</span>
                    <span>${metrics.recommendation.message}</span>
                `;
            } else if (recommendationBadge) {
                recommendationBadge.style.display = 'none';
            }
            
            // Update metrics grid
            const metricsGrid = document.querySelector('.metrics-grid');
            if (metricsGrid) {
                metricsGrid.innerHTML = `
                    <div class="metric-card">
                        <div class="metric-label">Average Sale Price</div>
                        <div class="metric-value">$${metrics.average}</div>
                        <div class="metric-detail">Based on ${selectedCount} recent sales</div>
                    </div>

                    <div class="metric-card">
                        <div class="metric-label">Net Proceeds (After Fees)</div>
                        <div class="metric-value">$${metrics.netProceeds}</div>
                        <div class="metric-detail">Fees: $${metrics.totalCosts}</div>
                    </div>

                    <div class="metric-card highlight">
                        <div class="metric-label">Suggested Purchase Price</div>
                        <div class="metric-value">$${metrics.suggestedPrice}</div>
                        <div class="metric-detail">Allows ${costSettings.profitMargin}% profit margin</div>
                    </div>

                    ${metrics.hasPurchasePrice ? `
                    <div class="metric-card">
                        <div class="metric-label">Realistic ROI</div>
                        <div class="metric-value ${parseFloat(metrics.roi) > 0 ? 'positive' : 'negative'}">
                            ${metrics.roi}%
                        </div>
                        <div class="metric-detail">Profit: $${metrics.potentialProfit}</div>
                    </div>` : ''}
                `;
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        // ‚îÄ‚îÄ‚îÄ Batch Mode ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        let batchMode = false;
        let batchItems = [];       // array of { name, avg, suggested }
        let currentResult = null;  // { salesData, metrics } from the last search

        function toggleBatchMode() {
            batchMode = !batchMode;
            const btn = document.getElementById('batchToggleBtn');
            btn.classList.toggle('active', batchMode);
            document.querySelector('.container').classList.toggle('batch-active', batchMode);

            // If results are already showing, toggle the Add button
            const resultsVisible = !document.getElementById('resultsSection').classList.contains('hidden');
            if (resultsVisible && currentResult) {
                document.getElementById('addToBatchBtn').classList.toggle('hidden', !batchMode);
            }

            // If turning off, hide the tray
            if (!batchMode) {
                document.getElementById('batchTray').classList.add('hidden');
            } else if (batchItems.length > 0) {
                document.getElementById('batchTray').classList.remove('hidden');
            }
        }

        function addCurrentToBatch() {
            if (!currentResult) return;

            const { salesData, metrics } = currentResult;
            batchItems.push({
                name: salesData.cardName,
                avg: parseFloat(metrics.average),
                suggested: parseFloat(metrics.suggestedPrice)
            });

            renderBatchTray();

            // Flash the button briefly
            const btn = document.getElementById('addToBatchBtn');
            btn.textContent = '‚úì Added!';
            btn.style.borderColor = '#60efff';
            btn.style.color = '#60efff';
            setTimeout(() => {
                btn.textContent = 'Ôºã Add to Batch';
                btn.style.borderColor = '';
                btn.style.color = '';
            }, 1000);
        }

        function removeFromBatch(index) {
            batchItems.splice(index, 1);
            renderBatchTray();
        }

        function clearBatch() {
            batchItems = [];
            renderBatchTray();
        }

        function renderBatchTray() {
            const tray = document.getElementById('batchTray');
            const countEl = document.getElementById('batchCount');
            const listEl = document.getElementById('batchItemsList');

            if (batchItems.length === 0) {
                tray.classList.add('hidden');
                return;
            }

            tray.classList.remove('hidden');
            countEl.textContent = batchItems.length + ' card' + (batchItems.length !== 1 ? 's' : '');

            // Render item rows
            listEl.innerHTML = batchItems.map((item, i) => `
                <div class="batch-item">
                    <div class="batch-item-number">${i + 1}</div>
                    <div class="batch-item-info">
                        <div class="batch-item-name">${item.name}</div>
                        <div class="batch-item-prices">
                            <span class="batch-item-avg">Avg: $${item.avg.toFixed(2)}</span>
                            <span class="batch-item-suggested">Max Pay: $${item.suggested.toFixed(2)}</span>
                        </div>
                    </div>
                    <button class="batch-item-remove" onclick="removeFromBatch(${i})">√ó</button>
                </div>
            `).join('');

            // Compute totals
            const totalAvg = batchItems.reduce((sum, c) => sum + c.avg, 0);
            const totalSuggested = batchItems.reduce((sum, c) => sum + c.suggested, 0);

            document.getElementById('batchTotalValue').textContent    = '$' + totalAvg.toFixed(2);
            document.getElementById('batchTotalSuggested').textContent = '$' + totalSuggested.toFixed(2);
            document.getElementById('batchMaxPay').textContent         = '$' + totalSuggested.toFixed(2);
        }

        function toggleBatchExpand() {
            const expanded = document.getElementById('batchExpanded');
            const arrow    = document.getElementById('batchExpandBtn');
            const isOpen   = !expanded.classList.contains('hidden');

            expanded.classList.toggle('hidden', isOpen);
            arrow.classList.toggle('expanded', !isOpen);
        }


        // Speech-to-Text functionality
        let recognition = null;
        let isListening = false;

        function initSpeechRecognition() {
            // Check browser support
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            
            if (!SpeechRecognition) {
                console.log('Speech recognition not supported');
                return null;
            }
            
            const recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'en-US';
            
            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                const cardQueryField = document.getElementById('cardQuery');
                
                // Append to existing text or replace
                if (cardQueryField.value) {
                    cardQueryField.value += ' ' + transcript;
                } else {
                    cardQueryField.value = transcript;
                }
                
                console.log('Voice input:', transcript);
                stopListening();
            };
            
            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                if (event.error === 'not-allowed') {
                    showError('Microphone access denied. Please allow microphone access in your browser settings.');
                } else if (event.error === 'no-speech') {
                    showError('No speech detected. Please try again.');
                } else {
                    showError('Voice input error: ' + event.error);
                }
                stopListening();
            };
            
            recognition.onend = () => {
                stopListening();
            };
            
            return recognition;
        }

        function toggleVoiceInput() {
            if (!recognition) {
                recognition = initSpeechRecognition();
                if (!recognition) {
                    showError('Voice input is not supported in your browser. Please use Chrome, Safari, or Edge.');
                    return;
                }
            }
            
            if (isListening) {
                stopListening();
            } else {
                startListening();
            }
        }

        function startListening() {
            try {
                recognition.start();
                isListening = true;
                document.getElementById('micButton').classList.add('listening');
                hideError();
            } catch (error) {
                console.error('Failed to start speech recognition:', error);
                showError('Could not start voice input. Please try again.');
            }
        }

        function stopListening() {
            if (recognition && isListening) {
                recognition.stop();
            }
            isListening = false;
            const micButton = document.getElementById('micButton');
            if (micButton) {
                micButton.classList.remove('listening');
            }
        }
    </script>
</body>
</html>
